#!/usr/bin/python
# Echo client program
import socket
import sys
import time

HOST = sys.argv[1]    # The remote host
PORT = 21721          # The same port as used by the server
s = None
for res in socket.getaddrinfo(HOST, PORT, socket.AF_UNSPEC, socket.SOCK_STREAM):
    af, socktype, proto, canonname, sa = res
    try:
	s = socket.socket(af, socktype, proto)
    except socket.error, msg:
	s = None
	continue
    try:
	s.connect(sa)
    except socket.error, msg:
	s.close()
	s = None
	continue
    break
if s is None:
    #print 'could not open socket'
    sys.exit(1)

#print "Getting headers"
header =  s.recv(1000)
#print header

#print "getting inputline"
#header =  s.recv(100000)
#print header

print "sending cmd"
s.send('listconsumers\n')
time.sleep(1)

data = ""
while True:
    tmp = s.recv(100)
    if not tmp:
        break

    data += tmp
    if ']' in data:
        break;

#print 'Received', repr(data)
import re
bla =1

m = re.findall("\'(.*?)\'", data, re.MULTILINE)
if m:
     blubb =  len(m)
     #data = s.recv(1024)
     for entry in m:
         blubb = blubb - 1
         if (blubb < 10): 
             if (bla):
                 bla = 0
             else:
                 header =  s.recv(100000)
             #print header
             cmd = 'readstatus ' + entry + '\n'
             #print "sending " + cmd
             s.send(cmd)
             data = s.recv(100000)
             #print 'Received', repr(data)
             key = re.search("status=([^\s]+)", data)
             print key.group(1)
        

s.close()
